<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Administration - Gestion des Fonds et Types de Prêt</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button, select { margin: 5px; padding: 5px; }
    .section { margin-bottom: 40px; padding: 20px; border: 1px solid #ccc; border-radius: 5px; }
    .section h2 { margin-top: 0; color: #333; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input[type="text"], input[type="number"], input[type="email"], input[type="date"], select { 
      width: 300px; 
      padding: 8px; 
      border: 1px solid #ccc; 
      border-radius: 3px; 
    }
    button { 
      background-color: #007bff; 
      color: white; 
      border: none; 
      padding: 10px 20px; 
      border-radius: 3px; 
      cursor: pointer; 
    }
    button:hover { background-color: #0056b3; }
    .btn-success { background-color: #28a745; }
    .btn-success:hover { background-color: #1e7e34; }
    .btn-warning { background-color: #ffc107; color: #212529; }
    .btn-warning:hover { background-color: #e0a800; }
    .message { padding: 10px; margin-top: 10px; border-radius: 3px; }
    .message.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .message.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .message.info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    .hidden { display: none; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    .fonds-info { background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .fonds-amount { font-size: 1.2em; font-weight: bold; color: #28a745; }
  </style>
</head>
<body>

  <h1>Administration - Gestion des Fonds et Types de Prêt</h1>

  <!-- Affichage des fonds disponibles -->
  <div class="fonds-info">
    <h3>Fonds disponibles</h3>
    <span class="fonds-amount" id="fonds-disponibles">Chargement...</span>
    <button onclick="chargerFondsDisponibles()">Actualiser</button>
  </div>

  <!-- Section Ajout de Fonds -->
  <div class="section">
    <h2>Ajouter des fonds</h2>
    <div class="form-group">
      <label for="montant">Montant (€)</label>
      <input type="number" step="0.01" min="0.01" id="montant" placeholder="Montant à ajouter">
    </div>
    <button onclick="ajouterFonds()">Ajouter</button>
    <div id="messageFonds" class="message hidden"></div>
  </div>

  <!-- Section Création de Type de Prêt -->
  <div class="section">
    <h2>Créer un type de prêt</h2>
    <div class="form-group">
      <label for="libelle">Nom du prêt</label>
      <input type="text" id="libelle" placeholder="Nom du type de prêt">
    </div>
    <div class="form-group">
      <label for="taux_annuel">Taux d'intérêt (%)</label>
      <input type="number" step="0.01" min="0" max="100" id="taux_annuel" placeholder="Taux d'intérêt annuel">
    </div>
    <div class="form-group">
      <label for="duree_max_mois">Durée maximale (mois)</label>
      <input type="number" min="1" step="1" id="duree_max_mois" placeholder="Durée maximale en mois">
    </div>
    <div class="form-group">
      <label for="montant_min">Montant minimal (€)</label>
      <input type="number" step="0.01" min="0" id="montant_min" placeholder="Montant minimal">
    </div>
    <div class="form-group">
      <label for="montant_max">Montant maximal (€)</label>
      <input type="number" step="0.01" min="0" id="montant_max" placeholder="Montant maximal">
    </div>
    <button class="btn-success" onclick="creerTypePret()">Créer le type de prêt</button>
    <div id="messageTypePret" class="message hidden"></div>
  </div>

  <!-- Section Demande de Prêt -->
  <div class="section">
    <h2>Faire une demande de prêt</h2>
    <div class="form-group">
      <label for="client_select">Sélectionner un client</label>
      <select id="client_select">
        <option value="">Choisir un client...</option>
      </select>
    </div>
    <div class="form-group">
      <label for="type_pret_select">Type de prêt</label>
      <select id="type_pret_select">
        <option value="">Choisir un type de prêt...</option>
      </select>
    </div>
    <div class="form-group">
      <label for="montant_pret">Montant demandé (€)</label>
      <input type="number" step="0.01" min="0" id="montant_pret" placeholder="Montant du prêt">
    </div>
    <div class="form-group">
      <label for="duree_pret">Durée (mois)</label>
      <input type="number" min="1" step="1" id="duree_pret" placeholder="Durée en mois">
    </div>
    <div class="form-group">
      <label for="date_debut">Date de début</label>
      <input type="date" id="date_debut">
    </div>
    <button class="btn-warning" onclick="creerPret()">Faire la demande de prêt</button>
    <div id="messagePret" class="message hidden"></div>
  </div>

  <!-- Section Affichage des Types de Prêt -->
  <div class="section">
    <h2>Types de prêt existants</h2>
    <button onclick="chargerTypesPret()">Actualiser la liste</button>
    <table id="table-types-pret">
      <thead>
        <tr>
          <th>ID</th><th>Nom</th><th>Taux (%)</th><th>Durée max (mois)</th><th>Montant min (€)</th><th>Montant max (€)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Section Affichage des Prêts -->
  <div class="section">
    <h2>Prêts en cours</h2>
    <button onclick="chargerPrets()">Actualiser la liste</button>
    <table id="table-prets">
      <thead>
        <tr>
          <th>ID</th><th>Client</th><th>Type</th><th>Montant (€)</th><th>Durée (mois)</th><th>Date début</th><th>Statut</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const apiBase = "http://localhost/Projet-S4/ws";

    function ajax(method, url, data, callback) {
      const xhr = new XMLHttpRequest();
      xhr.open(method, apiBase + url, true);
      xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
      xhr.onreadystatechange = () => {
        if (xhr.readyState === 4) {
          console.log('Réponse brute:', xhr.responseText);
          try {
            const response = JSON.parse(xhr.responseText);
            callback(response, xhr.status);
          } catch (e) {
            callback({ error: `Erreur de parsing JSON: ${e.message}` }, xhr.status);
          }
        }
      };
      console.log('Envoi de la requête:', method, apiBase + url, data);
      xhr.send(data);
    }

    function chargerFondsDisponibles() {
      ajax('GET', '/fonds', null, (response, status) => {
        if (status === 200 && response !== null) {
          document.getElementById('fonds-disponibles').textContent = response.toLocaleString() + ' €';
        } else {
          document.getElementById('fonds-disponibles').textContent = 'Erreur de chargement';
        }
      });
    }

    function chargerClients() {
      ajax('GET', '/clients', null, (response, status) => {
        if (status === 200 && !response.error) {
          const select = document.getElementById('client_select');
          select.innerHTML = '<option value="">Choisir un client...</option>';
          response.forEach(client => {
            const option = document.createElement('option');
            option.value = client.id_client;
            option.textContent = `${client.nom} (${client.email})`;
            select.appendChild(option);
          });
        }
      });
    }

    function chargerTypesPretSelect() {
      ajax('GET', '/type_pret', null, (response, status) => {
        if (status === 200 && !response.error) {
          const select = document.getElementById('type_pret_select');
          select.innerHTML = '<option value="">Choisir un type de prêt...</option>';
          response.forEach(type => {
            const option = document.createElement('option');
            option.value = type.id_type_pret;
            option.textContent = `${type.libelle} (${type.taux_annuel}% - ${type.montant_min}-${type.montant_max}€)`;
            select.appendChild(option);
          });
        }
      });
    }

    function creerPret() {
      const id_client = document.getElementById('client_select').value;
      const id_type_pret = document.getElementById('type_pret_select').value;
      const montant = document.getElementById('montant_pret').value;
      const duree_mois = document.getElementById('duree_pret').value;
      const date_debut = document.getElementById('date_debut').value;
      const messageDiv = document.getElementById('messagePret');

      // Validation côté client
      if (!id_client) {
        afficherMessage(messageDiv, 'Veuillez sélectionner un client.', 'error');
        return;
      }
      if (!id_type_pret) {
        afficherMessage(messageDiv, 'Veuillez sélectionner un type de prêt.', 'error');
        return;
      }
      if (!montant || parseFloat(montant) <= 0) {
        afficherMessage(messageDiv, 'Le montant doit être positif.', 'error');
        return;
      }
      if (!duree_mois || parseInt(duree_mois) <= 0) {
        afficherMessage(messageDiv, 'La durée doit être positive.', 'error');
        return;
      }
      if (!date_debut) {
        afficherMessage(messageDiv, 'La date de début est requise.', 'error');
        return;
      }

      const data = `id_client=${encodeURIComponent(id_client)}&id_type_pret=${encodeURIComponent(id_type_pret)}&montant=${encodeURIComponent(montant)}&duree_mois=${encodeURIComponent(duree_mois)}&date_debut=${encodeURIComponent(date_debut)}`;

      ajax('POST', '/pret', data, (response, status) => {
        if ((status === 200 || status === 201) && !response.error) {
          afficherMessage(messageDiv, response.message, 'success');
          resetFormPret();
          chargerFondsDisponibles();
          chargerPrets();
        } else {
          afficherMessage(messageDiv, response.error || 'Erreur lors de la création du prêt.', 'error');
        }
      });
    }

    function resetFormPret() {
      document.getElementById('client_select').value = '';
      document.getElementById('type_pret_select').value = '';
      document.getElementById('montant_pret').value = '';
      document.getElementById('duree_pret').value = '';
      document.getElementById('date_debut').value = '';
    }

    function chargerPrets() {
      ajax('GET', '/pret', null, (response, status) => {
        if (status === 200 && !response.error) {
          const tbody = document.querySelector("#table-prets tbody");
          tbody.innerHTML = "";
          if (response.length > 0) {
            response.forEach(pret => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${pret.id_pret}</td>
                <td>${pret.client_nom}</td>
                <td>${pret.type_pret_libelle}</td>
                <td>${parseFloat(pret.montant).toLocaleString()} €</td>
                <td>${pret.duree_mois}</td>
                <td>${pret.date_debut}</td>
                <td>${pret.statut_actuel || 'N/A'}</td>
              `;
              tbody.appendChild(tr);
            });
          } else {
            tbody.innerHTML = "<tr><td colspan='7'>Aucun prêt trouvé</td></tr>";
          }
        } else {
          console.error('Erreur lors du chargement des prêts:', response.error);
        }
      });
    }

    function ajouterFonds() {
      const montant = document.getElementById('montant').value;
      const messageDiv = document.getElementById('messageFonds');

      // Validation côté client
      if (!montant || parseFloat(montant) <= 0) {
        afficherMessage(messageDiv, 'Veuillez entrer un montant positif.', 'error');
        return;
      }

      const data = `montant=${encodeURIComponent(montant)}`;

      ajax('POST', '/fonds', data, (response, status) => {
        if (status === 200 && !response.error) {
          afficherMessage(messageDiv, response.message, 'success');
          document.getElementById('montant').value = '';
          chargerFondsDisponibles();
        } else {
          afficherMessage(messageDiv, response.error || 'Erreur lors de l\'ajout des fonds.', 'error');
        }
      });
    }

    function creerTypePret() {
      const libelle = document.getElementById('libelle').value.trim();
      const taux_annuel = document.getElementById('taux_annuel').value;
      const duree_max_mois = document.getElementById('duree_max_mois').value;
      const montant_min = document.getElementById('montant_min').value;
      const montant_max = document.getElementById('montant_max').value;
      const messageDiv = document.getElementById('messageTypePret');

      // Validation côté client
      if (!libelle) {
        afficherMessage(messageDiv, 'Le nom du prêt est requis.', 'error');
        return;
      }
      if (!taux_annuel || parseFloat(taux_annuel) < 0 || parseFloat(taux_annuel) > 100) {
        afficherMessage(messageDiv, 'Le taux d\'intérêt doit être entre 0 et 100.', 'error');
        return;
      }
      if (!duree_max_mois || parseInt(duree_max_mois) <= 0) {
        afficherMessage(messageDiv, 'La durée maximale doit être un entier positif.', 'error');
        return;
      }
      if (!montant_min || parseFloat(montant_min) < 0 || !montant_max || parseFloat(montant_max) < 0 || parseFloat(montant_min) > parseFloat(montant_max)) {
        afficherMessage(messageDiv, 'Les montants doivent être positifs et le minimum ne peut pas dépasser le maximum.', 'error');
        return;
      }

      const data = `libelle=${encodeURIComponent(libelle)}&taux_annuel=${encodeURIComponent(taux_annuel)}&duree_max_mois=${encodeURIComponent(duree_max_mois)}&montant_min=${encodeURIComponent(montant_min)}&montant_max=${encodeURIComponent(montant_max)}`;

      ajax('POST', '/type_pret', data, (response, status) => {
        if ((status === 200 || status === 201) && !response.error) {
          afficherMessage(messageDiv, response.message, 'success');
          resetFormTypePret();
          chargerTypesPret();
          chargerTypesPretSelect();
        } else {
          afficherMessage(messageDiv, response.error || 'Erreur lors de la création du type de prêt.', 'error');
        }
      });
    }

    function chargerTypesPret() {
      ajax('GET', '/type_pret', null, (response, status) => {
        if (status === 200 && !response.error) {
          const tbody = document.querySelector("#table-types-pret tbody");
          tbody.innerHTML = "";
          if (response.length > 0) {
            response.forEach(type => {
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${type.id_type_pret}</td>
                <td>${type.libelle}</td>
                <td>${type.taux_annuel}</td>
                <td>${type.duree_max_mois}</td>
                <td>${type.montant_min}</td>
                <td>${type.montant_max}</td>
              `;
              tbody.appendChild(tr);
            });
          } else {
            tbody.innerHTML = "<tr><td colspan='6'>Aucun type de prêt trouvé</td></tr>";
          }
        } else {
          console.error('Erreur lors du chargement des types de prêt:', response.error);
        }
      });
    }

    function resetFormTypePret() {
      document.getElementById('libelle').value = '';
      document.getElementById('taux_annuel').value = '';
      document.getElementById('duree_max_mois').value = '';
      document.getElementById('montant_min').value = '';
      document.getElementById('montant_max').value = '';
    }

    function afficherMessage(div, message, type) {
      div.className = `message ${type}`;
      div.textContent = message;
      div.classList.remove('hidden');
      
      // Masquer le message après 5 secondes
      setTimeout(() => {
        div.classList.add('hidden');
      }, 5000);
    }

    // Initialisation au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
      chargerFondsDisponibles();
      chargerTypesPret();
      chargerClients();
      chargerTypesPretSelect();
      chargerPrets();
      
      // Définir la date par défaut à aujourd'hui
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date_debut').value = today;
    });
  </script>

</body>
</html>