<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Client</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4">Espace Client</h1>
        <p id="welcome-message"></p>
        <div id="error-message" class="text-red-500 mb-4 hidden"></div>
        <a href="#" id="logout-link" class="text-blue-500 hover:underline">Déconnexion</a>
    </div>

    <script>
        const apiBase = "http://localhost/Projet-S4/ws/public";

        function ajax(method, url, data, callback) {
            const xhr = new XMLHttpRequest();
            xhr.open(method, apiBase + url, true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    console.log('Requête envoyée:', method, apiBase + url, 'Statut:', xhr.status); // Débogage
                    console.log('Réponse brute:', xhr.responseText); // Débogage
                    try {
                        const response = JSON.parse(xhr.responseText);
                        console.log('Réponse parsée:', response); // Débogage
                        callback(response, status);
                    } catch (e) {
                        console.error('Erreur de parsing JSON:', e.message, 'Réponse:', xhr.responseText); // Débogage
                        callback({ error: `Erreur de parsing JSON: ${e.message}. Réponse brute: ${xhr.responseText}` }, xhr.status);
                    }
                }
            };
            console.log('Envoi de la requête:', method, apiBase + url, data); // Débogage
            xhr.send(data);
        }

        function loadDashboard() {
            ajax('GET', '/client_acc personally_accueil', null, (response, status) => {
                console.log('Réponse reçue pour client_accueil:', response, 'Statut:', status); // Débogage
                if (response.error) {
                    document.getElementById('error-message').textContent = response.error;
                    document.getElementById('error-message').classList.remove('hidden');
                } else {
                    document.getElementById('welcome-message').textContent = response.message;
                }
            });
        }

        function logout() {
            ajax('GET', '/logout', null, (response, status) => {
                console.log('Réponse reçue pour logout:', response, 'Statut:', status); // Débogage
                if (response.error) {
                    document.getElementById('error-message').textContent = response.error;
                    document.getElementById('error-message').classList.remove('hidden');
                } else {
                    console.log('Redirection vers:', response.redirect); // Débogage
                    window.location.href = response.redirect;
                }
            });
        }

        document.getElementById('logout-link').addEventListener('click', (e) => {
            e.preventDefault();
            logout();
        });

        loadDashboard();
    </script>
</body>
</html>